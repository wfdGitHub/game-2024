//装备系统
const async = require("async")
const equip_lv = require("../../../../config/gameCfg/equip_lv.json")
const equip_qa = require("../../../../config/gameCfg/equip_qa.json")
const equip_slot = require("../../../../config/gameCfg/equip_slot.json")
const equip_suit = require("../../../../config/gameCfg/equip_suit.json")
const equip_st = require("../../../../config/gameCfg/equip_st.json")
const equip_spe = require("../../../../config/gameCfg/equip_spe.json")
const util = require("../../../../util/util.js")
const extra_list = ["M_HP","M_ATK","M_DEF","M_STK","M_SEF","M_SPE"]
for(var i in equip_qa){
	equip_qa[i].speWeights = [equip_qa[i]["spe_0"]]
	equip_qa[i].speWeights.push(equip_qa[i].speWeights[0] + equip_qa[i]["spe_1"])
	equip_qa[i].speWeights.push(equip_qa[i].speWeights[1] + equip_qa[i]["spe_2"])
}
for(var i in equip_slot)
	equip_slot[i]["spe_list"] = JSON.parse(equip_slot[i]["spe_list"])
for(var i in equip_lv){
	equip_lv[i]["qa_weights"] = [equip_lv[i]["weight_1"]]
	for(var j = 2;j <= 5;j++)
		equip_lv[i]["qa_weights"].push(equip_lv[i]["weight_"+j]+equip_lv[i]["qa_weights"][equip_lv[i]["qa_weights"].length-1])
	equip_lv[i]["high_weights"] = JSON.parse(JSON.stringify(equip_lv[i]["qa_weights"]))
	equip_lv[i]["high_weights"][3] += equip_lv[i]["weight_4"]
	equip_lv[i]["high_weights"][4] += equip_lv[i]["weight_5"] + equip_lv[i]["weight_4"]
	equip_lv[i]["suit_list"] = JSON.parse(equip_lv[i]["suit_list"])
}
const main_name = "equips"
var model = function() {
	var self = this
	var local = {}
	//获取数据
	this.getEquipData = function(uid,cb) {
		self.getObjAll(uid,main_name,function(data) {
			cb(true,data)
		})
	}
	//装备穿戴
	this.wearEquip = function(uid,hId,eId,cb) {
		var heroInfo,eStr,eInfo,oldEquip
		async.waterfall([
			function(next) {
				//检查英雄
				self.heroDao.getHeroOne(uid,hId,function(flag,data) {
					if(!data){
						next("英雄不存在")
						return
					}
					heroInfo = data
					next()
				})
			},
			function(next) {
				//检查装备
				self.getObj(uid,main_name,eId,function(data) {
					if(!data){
						next("装备不存在")
					}else{
						eStr = data
						eInfo = JSON.parse(eStr)
						next()
					}
				})
			},
			function(next) {
				//卸下原装备
				if(heroInfo["e"+eInfo.slot]){
					oldEquip = JSON.parse(heroInfo["e"+eInfo.slot])
					self.setObj(uid,main_name,oldEquip.id,heroInfo["e"+eInfo.slot])
					delete heroInfo["e"+eInfo.slot]
				}
				next()
			},
			function(next) {
				//穿戴装备
				self.delObj(uid,main_name,eId,function() {
					heroInfo["e"+eInfo.slot] = eStr
					self.heroDao.setHeroInfo(self.areaId,uid,hId,"e"+eInfo.slot,heroInfo["e"+eInfo.slot],function(flag,data) {
						cb(true,{heroInfo:heroInfo,oldEquip:oldEquip})
					})
				})
			}
		],function(err) {
			cb(false,err)
		})
	}
	//装备卸下
	this.unWearEquip = function(uid,hId,slot,cb) {
		self.heroDao.getHeroOne(uid,hId,function(flag,data) {
			if(!data){
				cb(false,"英雄不存在")
				return
			}
			var heroInfo = data
			if(heroInfo["e"+slot]){
				var eInfo = JSON.parse(heroInfo["e"+slot])
				self.setObj(uid,main_name,eInfo.id,heroInfo["e"+slot])
				delete heroInfo["e"+slot]
				self.heroDao.delHeroInfo(self.areaId,uid,hId,"e"+eInfo.slot,function(flag,data) {
					cb(true,heroInfo)
				})
			}
		})
	}
	//装备分解
	this.recycleEquip = function(uid,eIds,cb) {
		if(!eIds || !Array.isArray(eIds) || !eIds.length){
			cb(false,"eIds error "+eIds)
			return
		}
		var hIdmap = {}
		for(var i = 0;i < eIds.length;i++){
			if(hIdmap[eIds[i]]){
			  	cb(false,"eId不能重复")
			  	return
			}
			hIdmap[eIds[i]] = true
		}
		self.getHMObj(uid,main_name,eIds,function(list) {
			for(var i = 0;i < list.length;i++){
			 	if(!list[i]){
			 		cb(false,"eId error "+eIds[i])
			 		return
			 	}
			 	list[i] = JSON.parse(list[i])
			}
			var str = self.fightContorl.getEquipRecycle(list)
			for(var i = 0;i < list.length;i++)
				self.delObj(uid,main_name,list[i]["id"])
			var awardList = self.addItemStr(uid,str,1,"装备分解")
			cb(true,awardList)
		})
	}
	//装备打造
	this.makeEquip = function(uid,lv,slot,item,cb) {
		async.waterfall([
			function(next) {
				//参数判断
				if(!equip_lv[lv] || !equip_slot[slot]){
					next("参数错误")
					return
				}
				if(item && item != 2003400 && item != 2003500){
					next("item error "+item)
					return
				}
				next()
			},
			function(next) {
				//消耗判断
				var pc = equip_lv[lv]["pc"]
				if(item)
					pc += "&"+item+":"+1
				self.consumeItems(uid,pc,1,"装备打造",function(flag,err) {
					if(flag)
						next()
					else
						next(err)
				})
			},
			function(next) {
				var id = self.getLordLastid(uid)
				var info = self.gainEquip(lv,slot,0,item)
				info.id = id
				info = JSON.stringify(info)
				self.setObj(uid,main_name,id,info)
				cb(true,info)
			}
		],function(err) {
			cb(false,err)
		})
	}
	//装备洗练
	this.washEquip = function(uid,eId,item,cb) {
		var info = {}
		async.waterfall([
			function(next) {
				//参数判断
				if(item && item != 2003400 && item != 2003500){
					next("item error "+item)
					return
				}
				self.getObj(uid,main_name,eId,function(data) {
					if(!data){
						next("装备不存在")
					}else{
						info = JSON.parse(data)
						next()
					}
				})
			},
			function(next) {
				//消耗判断
				var pc = equip_lv[info.lv]["wash_pc"]
				if(item)
					pc += "&"+item+":"+1
				self.consumeItems(uid,pc,1,"装备洗练",function(flag,err) {
					if(flag)
						next()
					else
						next(err)
				})
			},
			function(next) {
				//操作
				var id = info.id
				info.wash = self.gainEquip(info.lv,info.slot)
				info = JSON.stringify(info)
				self.setObj(uid,main_name,id,info)
				cb(true,info)
			}
		],function(err) {
			cb(false,err)
		})
	}
	//洗练保存
	this.saveEquip = function(uid,eId,cb) {
		var info = {}
		async.waterfall([
			function(next) {
				//参数判断
				self.getObj(uid,main_name,eId,function(data) {
					if(!data){
						next("装备不存在")
						return
					}
					info = JSON.parse(data)
					if(!info.wash){
						next("没有可保存的属性")
						return	
					}
					next()
				})
			},
			function(next) {
				//操作
				var id = info.id
				var st = info.st
				info = info.wash
				info.id = id
				info.st = st
				info = JSON.stringify(info)
				self.setObj(uid,main_name,id,info)
				cb(true,info)
			}
		],function(err) {
			cb(false,err)
		})
	}
	//属性转化
	this.washEquipExtra = function(uid,eId,cb) {
		var info = {}
		async.waterfall([
			function(next) {
				//参数判断
				self.getObj(uid,main_name,eId,function(data) {
					if(!data){
						next("装备不存在")
					}else{
						info = JSON.parse(data)
						next()
					}
				})
			},
			function(next) {
				//消耗判断
				self.consumeItems(uid,equip_lv[info.lv]["extra_pc"],1,"属性转化",function(flag,err) {
					if(flag)
						next()
					else
						next(err)
				})
			},
			function(next) {
				//操作
				info.washExtra = local.createExtra(info,info.att.extra.type)
				var id = info.id
				info = JSON.stringify(info)
				self.setObj(uid,main_name,id,info)
				cb(true,info)
			}
		],function(err) {
			cb(false,err)
		})
	}
	//属性保存
	this.saveEquipExtra = function(uid,eId,cb) {
		var info = {}
		async.waterfall([
			function(next) {
				//参数判断
				self.getObj(uid,main_name,eId,function(data) {
					if(!data){
						next("装备不存在")
						return
					}
					info = JSON.parse(data)
					if(!info.washExtra){
						next("没有可保存的洗练属性")
						return	
					}
					next()
				})
			},
			function(next) {
				//操作
				info.att.extra = info.washExtra
				delete info.washExtra
				var id = info.id
				info = JSON.stringify(info)
				self.setObj(uid,main_name,id,info)
				cb(true,info)
			}
		],function(err) {
			cb(false,err)
		})
	}
	//特效转化
	this.washEquipSpe = function(uid,eId,index,cb) {
		var info = {}
		async.waterfall([
			function(next) {
				//参数判断
				self.getObj(uid,main_name,eId,function(data) {
					if(!data){
						next("装备不存在")
						return
					}
					info = JSON.parse(data)
					if(!info.spe || !info.spe[index]){
						next("不存在该特效")
						return
					}
					next()
				})
			},
			function(next) {
				//消耗判断
				self.consumeItems(uid,equip_lv[info.lv]["spe_pc"],1,"特效转化",function(flag,err) {
					if(flag)
						next()
					else
						next(err)
				})
			},
			function(next) {
				//操作
				var map = {}
				for(var i = 0;i < info.spe.length;i++)
					map[info.spe[i]] = 1
				var speList = util.getRandomArray(equip_slot[info.slot]["spe_list"],3)
				for(var i = 0;i < speList.length;i++){
					if(!map[speList[i]]){
						info.washSpe = JSON.parse(JSON.stringify(info.spe))
						info.washSpe[index] = speList[i]
						break
					}
				}
				var id = info.id
				info = JSON.stringify(info)
				self.setObj(uid,main_name,id,info)
				cb(true,info)
			}
		],function(err) {
			cb(false,err)
		})
	}
	//特效保存
	this.saveEquipSpe = function(uid,eId,cb) {
		var info = {}
		async.waterfall([
			function(next) {
				//参数判断
				self.getObj(uid,main_name,eId,function(data) {
					if(!data){
						next("装备不存在")
						return
					}
					info = JSON.parse(data)
					if(!info.washSpe){
						next("没有可保存的洗练特效")
						return	
					}
					next()
				})
			},
			function(next) {
				//操作
				info.spe = info.washSpe
				delete info.washSpe
				var id = info.id
				info = JSON.stringify(info)
				self.setObj(uid,main_name,id,info)
				cb(true,info)
			}
		],function(err) {
			cb(false,err)
		})
	}
	//套装转化
	this.washEquipSuit = function(uid,eId,cb) {
		var info = {}
		async.waterfall([
			function(next) {
				//参数判断
				self.getObj(uid,main_name,eId,function(data) {
					if(!data){
						next("装备不存在")
						return
					}
					info = JSON.parse(data)
					if(!info.suit){
						next("不存在套装效果")
						return
					}
					next()
					
				})
			},
			function(next) {
				//消耗判断
				self.consumeItems(uid,equip_lv[info.lv]["suit_pc"],1,"套装转化",function(flag,err) {
					if(flag)
						next()
					else
						next(err)
				})
			},
			function(next) {
				//操作
				info.washSuit = local.createSuit(info)
				var id = info.id
				info = JSON.stringify(info)
				self.setObj(uid,main_name,id,info)
				cb(true,info)
			}
		],function(err) {
			cb(false,err)
		})
	}
	//套装保存
	this.saveEquipSuit = function(uid,eId,cb) {
		var info = {}
		async.waterfall([
			function(next) {
				//参数判断
				self.getObj(uid,main_name,eId,function(data) {
					if(!data){
						next("装备不存在")
						return
					}
					info = JSON.parse(data)
					if(!info.washSuit){
						next("没有可保存的套装效果")
						return	
					}
					next()
				})
			},
			function(next) {
				//操作
				info.suit = info.washSuit
				delete info.washSuit
				var id = info.id
				info = JSON.stringify(info)
				self.setObj(uid,main_name,id,info)
				cb(true,info)
			}
		],function(err) {
			cb(false,err)
		})
	}
	//装备强化
	this.intensifyEquip = function(uid,eId,cb) {
		var info = {}
		async.waterfall([
			function(next) {
				//参数判断
				self.getObj(uid,main_name,eId,function(data) {
					if(!data){
						next("装备不存在")
						return
					}
					info = JSON.parse(data)
					info.st = info.st || 0
					if(info.st >= equip_lv[info.lv]["st_max"]){
						next("强化等级已满")
						return
					}
					next()
				})
			},
			function(next) {
				//消耗判断
				self.consumeItems(uid,equip_st[info.st]["pc"],1,"装备强化",function(flag,err) {
					if(flag)
						next()
					else
						next(err)
				})
			},
			function(next) {
				//操作
				var id = info.id
				info.st++
				info = JSON.stringify(info)
				self.setObj(uid,main_name,id,info)
				cb(true,info)
			}
		],function(err) {
			cb(false,err)
		})
	}
	//获得装备
	this.gainEquip = function(lv,slot,qa,item) {
		var info = {}
		info.lv = lv
		info.slot = slot
		if(qa)
			info.qa = qa
		else{
			if(item == 2003400){
				//强化打造
				info.qa = util.getWeightedRandomBySort(equip_lv[lv]["high_weights"]) + 1
			}else if(item == 2003500){
				//必定异化
				info.qa = 5
			}else{
				info.qa = util.getWeightedRandomBySort(equip_lv[lv]["qa_weights"]) + 1
			}
		}
		info.att = local.createAtt(info)
		var spe = local.createSpe(info)
		if(spe)
			info.spe = spe
		if(info.qa >= 5)
			info.suit = local.createSuit(info)
		return info
	}
	//装备随机生成属性
	local.createAtt = function(info) {
		var c_info = {}
		c_info.main_1 = equip_qa[info.qa]["mainRate"] * (Math.random() * 0.1 + 0.95)
		c_info.main_2 = equip_qa[info.qa]["mainRate"] * (Math.random() * 0.1 + 0.95)
		c_info.extra = local.createExtra(info,Math.floor(Math.random() * 3))
		return c_info
	}
	//装备随机生成额外属性
	local.createExtra = function(info,type) {
		var extra = {}
		extra.type = type
		switch(type){
			case 0:
				//单加属性
				var list = util.getRandomArray(extra_list,1)
				for(var i = 0;i < list.length;i++)
					extra[list[i]] = Math.ceil(equip_qa[info.qa]["extraRate"] * (Math.random() * 0.2 + 0.85) * equip_lv[info.lv]["extra"] * 0.75)
			break
			case 1:
				//双加属性
				var list = util.getRandomArray(extra_list,2)
				for(var i = 0;i < list.length;i++)
					extra[list[i]] = Math.ceil(equip_qa[info.qa]["extraRate"] * (Math.random() * 0.2 + 0.85) * equip_lv[info.lv]["extra"] * 0.5)
			break
			default:
				//加减属性
				var list = util.getRandomArray(extra_list,2)
				var rate = (Math.random() * 0.2 + 0.85)
				extra[list[0]] = Math.ceil(equip_qa[info.qa]["extraRate"] * rate * equip_lv[info.lv]["extra"] * 0.9)
				extra[list[1]] = Math.ceil(equip_qa[info.qa]["extraRate"] * rate * equip_lv[info.lv]["extra"] * -0.3)
		}
		return extra
	}
	//装备随机生成特效
	local.createSpe = function(info) {
		if(!equip_lv[info.lv]["spe"])
			return false
		var spe = []
		var count = util.getWeightedRandomBySort(equip_qa[info.qa].speWeights)
		if(count > 0)
			return util.getRandomArray(equip_slot[info.slot]["spe_list"],count)
		else
			return false
	}
	//装备随机生成套装
	local.createSuit = function(info) {
		var index = Math.floor(Math.random() * equip_lv[info.lv]["suit_list"].length)
		if(equip_lv[info.lv]["suit_list"][index] == info.suit)
			index = (index+1)%equip_lv[info.lv]["suit_list"].length
		return equip_lv[info.lv]["suit_list"][index]
	}
}
module.exports = model


// var test = new model()
// console.log(test.gainEquip(6,1,5))